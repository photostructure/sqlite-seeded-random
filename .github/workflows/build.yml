name: Build

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type"
        required: false
        type: choice
        default: "patch"
        options:
          - patch
          - minor
          - major

permissions:
  contents: read

jobs:
  # ── Lint (runs on every push/PR) ────────────────────────────────────
  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: lts/*
      - run: npm ci
      - run: npm run lint

  # ── Build native extensions (runs on every push/PR) ───────────────────
  build-linux-x64:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: make loadable
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: linux-x64
          path: dist/seeded_random.so

  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: make loadable
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: linux-arm64
          path: dist/seeded_random.so

  build-linux-x64-musl:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform linux/amd64 node:20-alpine -c "\
          apk add build-base --update-cache && \
          cd /tmp/project && \
          make loadable"
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: linux-x64-musl
          path: dist/seeded_random.so

  build-linux-arm64-musl:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform linux/arm64 node:20-alpine -c "\
          apk add build-base --update-cache && \
          cd /tmp/project && \
          make loadable"
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: linux-arm64-musl
          path: dist/seeded_random.so

  build-darwin-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: make loadable
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: darwin-x64
          path: dist/seeded_random.dylib

  build-darwin-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - run: make loadable
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: darwin-arm64
          path: dist/seeded_random.dylib

  build-win32-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0
      - run: mkdir dist
      - run: cl.exe /W4 /Ivendor/ /O2 /LD seeded_random.c /Fedist/seeded_random.dll
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: win32-x64
          path: dist/seeded_random.dll

  build-win32-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0
        with:
          arch: arm64
      - run: mkdir dist
      - run: cl.exe /W4 /Ivendor/ /O2 /LD seeded_random.c /Fedist/seeded_random.dll
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: win32-arm64
          path: dist/seeded_random.dll

  # ── Test against built artifacts ─────────────────────────────────────
  test:
    needs:
      [
        build-linux-x64,
        build-linux-arm64,
        build-darwin-x64,
        build-darwin-arm64,
        build-win32-x64,
        build-win32-arm64,
      ]
    strategy:
      matrix:
        include:
          # Multiple Node versions on linux-x64
          - { os: ubuntu-24.04, artifact: linux-x64, node-version: 20 }
          - { os: ubuntu-24.04, artifact: linux-x64, node-version: 22 }
          - { os: ubuntu-24.04, artifact: linux-x64, node-version: 24 }
          - { os: ubuntu-24.04, artifact: linux-x64, node-version: 25 }
          # Other platforms on LTS node
          - { os: ubuntu-24.04-arm, artifact: linux-arm64, node-version: 22 }
          - { os: macos-15-intel, artifact: darwin-x64, node-version: 22 }
          - { os: macos-14, artifact: darwin-arm64, node-version: 22 }
          - { os: windows-latest, artifact: win32-x64, node-version: 22 }
          - { os: windows-11-arm, artifact: win32-arm64, node-version: 22 }
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ matrix.artifact }}
          path: dist/
      - run: npm ci
      - run: npm run build:js
      - run: npm test

  # ── Release (manual only, requires all builds + tests to pass) ────────
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    needs:
      [
        lint,
        test,
        build-linux-x64-musl,
        build-linux-arm64-musl,
      ]
    permissions:
      id-token: write # Required for OIDC trusted publishing to npm
      contents: write # Required for tags/commits/releases
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: linux-x64
          path: dist/linux-x64
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: linux-arm64
          path: dist/linux-arm64
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: linux-x64-musl
          path: dist/linux-x64-musl
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: linux-arm64-musl
          path: dist/linux-arm64-musl
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: darwin-x64
          path: dist/darwin-x64
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: darwin-arm64
          path: dist/darwin-arm64
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: win32-x64
          path: dist/win32-x64
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: win32-arm64
          path: dist/win32-arm64

      - run: ls -laR dist/

      # setup-node with registry-url is required for OIDC trusted publishing
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"

      - uses: photostructure/git-ssh-signing-action@fdd4b062a9ba41473f013258cc9c7eea1640f826 # v1.2.0
        with:
          ssh-signing-key: ${{ secrets.SSH_SIGNING_KEY }}
          git-user-name: ${{ secrets.GIT_USER_NAME }}
          git-user-email: ${{ secrets.GIT_USER_EMAIL }}

      # Upgrade npm to support OIDC trusted publishing (requires npm >= 11.5.1)
      - run: npm install -g npm@latest

      - run: npm ci

      - run: npx tsup

      - name: Bump version
        run: |
          npm version ${{ github.event.inputs.version }} -m "release: %s" --sign-git-tag

      - name: Get version
        id: version
        run: echo "version=v$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Push changes
        run: git push origin main --follow-tags

      - name: Create GitHub Release
        run: gh release create ${{ steps.version.outputs.version }} --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to npm
        run: npm publish --provenance --access public
